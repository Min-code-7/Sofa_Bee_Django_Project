{% extends "base.html" %}
{% load static %}
{% csrf_token %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Products List</h2>

    <!-- Search Bar -->
    <div class="row mb-3">
        <div class="col-md-9">
            <input type="text" id="search-input" class="form-control" placeholder="Please input product name to search...">
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary" id="search-btn">Search</button>
        </div>
    </div>

    <!-- productList -->
    <div class="row" id="product-list">
        {% for product in products %}
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                {% if product.image %}
                <img src="{{ product.image }}" class="card-img-top" alt="{{ product.name }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text">{{ product.description|truncatewords:15 }}</p>
                    <p><strong>Price: <span class="text-primary">${{ product.price }}</span></strong></p>
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'products:product_detail' product.id %}" class="btn btn-primary">View Details</a>
                        <button class="btn btn-success add-to-cart" data-id="{{ product.id }}">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col text-center">
            <p class="text-muted">No products available</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- jQuery + AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Search button click event
    $("#search-btn").click(function() {
        searchProducts();
    });
    
    // Add to cart button click event
    $(".add-to-cart").click(function() {
        var productId = $(this).data("id");
        addToCart(productId);
    });
    
    // Search products function
    function searchProducts() {
        var query = $("#search-input").val();
        $.ajax({
            url: "{% url 'products:product_search' %}",
            data: { q: query },
            dataType: "json",
            success: function(data) {
                $("#product-list").html("");

                if (data.products.length === 0) {
                    $("#product-list").html("<p class='text-muted text-center'>No matching items found.</p>");
                } else {
                    $.each(data.products, function(index, product) {
                        var html = '<div class="col-md-4 mb-4">';
                        html += '<div class="card shadow-sm">';
                        html += '<img src="' + product.image + '" class="card-img-top" alt="' + product.name + '">';
                        html += '<div class="card-body">';
                        html += '<h5 class="card-title">' + product.name + '</h5>';
                        html += '<p class="card-text">' + product.description + '</p>';
                        html += '<p><strong>Price: <span class="text-primary">$' + product.price.toFixed(2) + '</span></strong></p>';
                        html += '<div class="d-flex justify-content-between">';
                        html += '<a href="/products/' + product.id + '/" class="btn btn-primary">View Details</a>';
                        html += '<button class="btn btn-success add-to-cart" data-id="' + product.id + '">Add to Cart</button>';
                        html += '</div></div></div></div>';
                        $("#product-list").append(html);
                    });
                    
                    // Rebind click event for new add-to-cart buttons
                    $(".add-to-cart").click(function() {
                        var productId = $(this).data("id");
                        addToCart(productId);
                    });
                }
            }
        });
    }
    
    // Add to cart function
    function addToCart(productId) {
        console.log("Adding product to cart:", productId);
        
        // Get CSRF token from cookie
        var csrftoken = getCookie('csrftoken');
        
        $.ajax({
            url: '/cart/add/' + productId + '/',
            type: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            },
            success: function(data) {
                console.log("Response data:", data);
                if (data.status === 'success') {
                    alert(data.message);
                    location.reload(); 
                } else {
                    alert(data.message || 'Error adding to cart');
                }
            },
            error: function(error) {
                console.error('Error:', error);
                alert('An error occurred while adding to cart');
            }
        });
    }
    
    // Helper function to get cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
