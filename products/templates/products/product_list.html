{% extends "base.html" %}
{% load static %}
{% csrf_token %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Products List</h2>

    <!-- Search and Add Product Bar -->
    <div class="row mb-3">
        <div class="{% if user.is_authenticated and user.userprofile.user_type == 'merchant' %}col-md-7{% else %}col-md-9{% endif %}">
            <input type="text" id="search-input" class="form-control" placeholder="Please input product name to search...">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="searchProducts()">Search</button>
        </div>
        {% if user.is_authenticated and user.userprofile.user_type == 'merchant' %}
        <div class="col-md-3">
            <a href="{% url 'products:add_product' %}" class="btn btn-success w-100">Add New Product</a>
        </div>
        {% endif %}
    </div>

    <!-- Categories Filter -->
    {% if categories %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-2">
                <a href="{% url 'products:product_list' %}" class="btn btn-outline-secondary {% if not selected_category %}active{% endif %}">
                    All
                </a>
                {% for category in categories %}
                <a href="{% url 'products:product_list' %}?category={{ category.name }}" 
                   class="btn btn-outline-secondary {% if selected_category == category.name %}active{% endif %}">
                    {{ category.name }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- productList -->
    <div class="row" id="product-list">
        {% for product in products %}
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm">
                {% if product.image %}
                <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                {% else %}
                <div class="text-center py-5 bg-light">No Image</div>
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text">{{ product.description|truncatewords:15 }}</p>
                    <p><strong>Price: <span class="text-primary">${{ product.price }}</span></strong></p>
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'products:product_detail' product.id %}" class="btn btn-primary">View Details</a>
                        <button class="btn btn-success" onclick="addToCart({{ product.id }})">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">No products available yet</h5>
                    
                    {% if user.is_authenticated and user.userprofile.user_type == 'merchant' %}
                    <p class="card-text">As a merchant, you can add products to your store.</p>
                    <a href="{% url 'products:add_product' %}" class="btn btn-lg btn-success mt-3">
                        <i class="fas fa-plus-circle"></i> Add Your First Product
                    </a>
                    {% else %}
                    <p class="card-text">Products will be available soon. Please check back later!</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- jQuery + AJAX -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function searchProducts() {
        var query = $("#search-input").val();
        $.ajax({
            url: "{% url 'products:product_search' %}",
            data: { q: query },
            dataType: "json",
            success: function(data) {
                $("#product-list").html("");

                if (data.products.length === 0) {
                    $("#product-list").html(`
                        <div class="col-12 text-center py-5">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title text-muted">No matching products found</h5>
                                    <p class="card-text">Try different search terms or browse categories.</p>
                                    <button class="btn btn-outline-secondary mt-3" onclick="window.location.reload()">
                                        Reset Search
                                    </button>
                                </div>
                            </div>
                        </div>
                    `);
                } else {
                    $.each(data.products, function(index, product) {
                        var imageHtml = product.image ? 
                            `<img src="${product.image}" class="card-img-top" alt="${product.name}">` : 
                            '<div class="text-center py-5 bg-light">No Image</div>';
                            
                        $("#product-list").append(`
                            <div class="col-md-4 mb-4">
                                <div class="card shadow-sm">
                                    ${imageHtml}
                                    <div class="card-body">
                                        <h5 class="card-title">${product.name}</h5>
                                        <p class="card-text">${product.description}</p>
                                        <p><strong>Price: <span class="text-primary">$${product.price.toFixed(2)}</span></strong></p>
                                        <div class="d-flex justify-content-between">
                                            <a href="/products/${product.id}/" class="btn btn-primary">View Details</a>
                                            <button class="btn btn-success" onclick="addToCart(${product.id})">Add to Cart</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                }
            }
        });
    }
    
    function addToCart(productId) {
        console.log("Adding product to cart:", productId);
    
        // Get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        const csrftoken = getCookie('csrftoken');
    
        fetch(`/cart/add/${productId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            console.log("Response status:", response.status);
            return response.json();
        })
        .then(data => {
            console.log("Response data:", data);
            if (data.status === 'success') {
                alert(data.message);
                location.reload(); 
            } else {
                alert(data.message || 'Error adding to cart');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding to cart');
        });
    }
</script>
{% endblock %}